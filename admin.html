<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9RA O NCHT - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.45.1"
      }
    }
    </script>
    <style>
        body {
            background-color: #050510;
            color: #e2e8f0;
            font-family: 'Noto Sans Arabic', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .glass {
            background: rgba(15, 15, 35, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 242, 255, 0.2);
        }
        .neon-glow {
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
        }
        .cyber-input {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            transition: all 0.3s ease;
        }
        .cyber-input:focus {
            border-color: #00f2ff !important;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
            outline: none;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1a1a4a; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="admin-root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom';
        import { createClient } from '@supabase/supabase-js';

        const supabaseUrl = 'https://sogywxbavcwtbtcirvsw.supabase.co';
        const supabaseKey = 'sb_publishable_svYdUF0MDpCbpjZ2jyAPww_1UlwAtAV';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const ADMIN_PASSWORD = 'ADMIN_9RA_2025';

        const AdminPortal = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [passInput, setPassInput] = useState('');
            const [questions, setQuestions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeEmail, setActiveEmail] = useState(null); // null means General Questions
            const [isAddingEmail, setIsAddingEmail] = useState(false);
            const [newEmail, setNewEmail] = useState('');
            const [status, setStatus] = useState({ type: '', msg: '' });

            const [formData, setFormData] = useState({
                question_text: '',
                option_a: '',
                option_b: '',
                option_c: '',
                correct_option: 0
            });

            const handleLogin = (e) => {
                e.preventDefault();
                if (passInput === ADMIN_PASSWORD) {
                    setIsLoggedIn(true);
                } else {
                    alert('ACCESS DENIED: Invalid Command Key');
                }
            };

            const fetchAllData = async () => {
                setLoading(true);
                const { data, error } = await supabase
                    .from('custom_questions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (data) setQuestions(data);
                setLoading(false);
            };

            useEffect(() => {
                if (isLoggedIn) fetchAllData();
            }, [isLoggedIn]);

            const uniqueEmails = useMemo(() => {
                const emails = questions
                    .map(q => q.assigned_to_ema)
                    .filter(email => email !== null && email !== '');
                return [...new Set(emails)];
            }, [questions]);

            const handleAddQuestion = async (e) => {
                e.preventDefault();
                setLoading(true);
                const payload = {
                    ...formData,
                    assigned_to_ema: activeEmail
                };

                const { error } = await supabase.from('custom_questions').insert([payload]);

                if (error) {
                    setStatus({ type: 'error', msg: 'فشل الإرسال: ' + error.message });
                } else {
                    setStatus({ type: 'success', msg: 'تم بنجاح! تم تحديث القطاع.' });
                    setFormData({ question_text: '', option_a: '', option_b: '', option_c: '', correct_option: 0 });
                    fetchAllData();
                }
                setLoading(false);
                setTimeout(() => setStatus({ type: '', msg: '' }), 3000);
            };

            const deleteQuestion = async (id) => {
                if (!confirm('سيتم حذف هذا السؤال نهائياً. هل أنت متأكد؟')) return;
                const { error } = await supabase.from('custom_questions').delete().eq('id', id);
                if (!error) fetchAllData();
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="glass p-12 rounded-[3rem] w-full max-w-md neon-glow text-center border-t-4 border-cyan-500">
                            <h1 className="orbitron text-4xl font-black text-white mb-2 uppercase tracking-tighter">Command Center</h1>
                            <p className="text-cyan-400 text-[10px] font-bold tracking-[0.4em] mb-8 uppercase">Restricted Area</p>
                            <form onSubmit={handleLogin} className="space-y-6">
                                <input 
                                    type="password" 
                                    placeholder="ENTER ACCESS KEY"
                                    className="w-full cyber-input p-4 rounded-2xl text-center text-xl orbitron"
                                    value={passInput}
                                    onChange={(e) => setPassInput(e.target.value)}
                                />
                                <button className="w-full py-4 bg-cyan-600 hover:bg-cyan-500 rounded-2xl font-black orbitron transition-all shadow-[0_0_20px_rgba(8,145,178,0.4)]">
                                    INITIATE LINK
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            const filteredQuestions = questions.filter(q => q.assigned_to_ema === activeEmail);

            return (
                <div className="min-h-screen p-4 md:p-10 max-w-7xl mx-auto flex flex-col">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-10 bg-black/40 p-8 rounded-[2.5rem] border border-white/5 glass">
                        <div className="text-right mb-4 md:mb-0">
                            <h1 className="orbitron text-3xl md:text-4xl font-black text-white leading-none">SECTOR ADMIN</h1>
                            <p className="text-cyan-400 text-xs font-bold tracking-widest uppercase mt-2">Mission Intelligence Dashboard</p>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => window.location.href = '/'} className="px-8 py-3 bg-white/5 border border-white/10 text-gray-400 rounded-full hover:bg-white/10 hover:text-white transition-all text-xs font-black orbitron uppercase">
                                Return to Base
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 flex-1">
                        
                        {/* Sidebar: User Selection */}
                        <div className="lg:col-span-3 space-y-6">
                            <div className="glass p-6 rounded-[2rem] border-r-4 border-cyan-500/30">
                                <h3 className="orbitron text-xs font-black text-cyan-400 tracking-widest mb-6 uppercase">Target Select</h3>
                                
                                <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                                    <button 
                                        onClick={() => { setActiveEmail(null); setIsAddingEmail(false); }}
                                        className={`w-full text-right px-5 py-4 rounded-2xl transition-all font-bold flex items-center justify-between ${activeEmail === null ? 'bg-cyan-600 text-white shadow-lg' : 'hover:bg-white/5 text-gray-400'}`}
                                    >
                                        الأسئلة العامة (Guest)
                                        <div className={`w-2 h-2 rounded-full ${activeEmail === null ? 'bg-white animate-pulse' : 'bg-gray-600'}`}></div>
                                    </button>

                                    <div className="h-px bg-white/5 my-4"></div>

                                    {uniqueEmails.map(email => (
                                        <button 
                                            key={email}
                                            onClick={() => { setActiveEmail(email); setIsAddingEmail(false); }}
                                            className={`w-full text-right px-5 py-4 rounded-2xl transition-all text-sm font-bold truncate ${activeEmail === email ? 'bg-purple-600 text-white shadow-lg' : 'hover:bg-white/5 text-gray-400'}`}
                                        >
                                            {email}
                                        </button>
                                    ))}
                                </div>

                                <div className="mt-6 pt-6 border-t border-white/5">
                                    {isAddingEmail ? (
                                        <div className="space-y-2 animate-fade-in">
                                            <input 
                                                type="email" 
                                                placeholder="أدخل إيميل جديد..."
                                                className="w-full cyber-input p-3 rounded-xl text-xs"
                                                value={newEmail}
                                                onChange={e => setNewEmail(e.target.value)}
                                            />
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => { if(newEmail) { setActiveEmail(newEmail); setIsAddingEmail(false); setNewEmail(''); } }}
                                                    className="flex-1 bg-cyan-600 py-2 rounded-lg text-[10px] font-black"
                                                >تأكيد</button>
                                                <button 
                                                    onClick={() => setIsAddingEmail(false)}
                                                    className="flex-1 bg-white/5 py-2 rounded-lg text-[10px] font-black"
                                                >إلغاء</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <button 
                                            onClick={() => setIsAddingEmail(true)}
                                            className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-gray-500 hover:border-cyan-500/50 hover:text-cyan-400 transition-all text-xs font-black flex items-center justify-center gap-2"
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M12 4v16m8-8H4"></path></svg>
                                            إضافة إيميل جديد
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Main Content: Question Manager */}
                        <div className="lg:col-span-9 space-y-8">
                            
                            {/* Form Section */}
                            <div className="glass p-8 rounded-[2.5rem] relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-2 h-full bg-cyan-500"></div>
                                <h2 className="text-2xl font-black mb-8 flex items-center gap-4">
                                    <span className="p-3 bg-cyan-500/10 rounded-xl text-cyan-400">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    </span>
                                    إضافة سؤال مخصص لـ: 
                                    <span className="text-cyan-400 orbitron"> {activeEmail || 'الأسئلة العامة'}</span>
                                </h2>

                                <form onSubmit={handleAddQuestion} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="md:col-span-2">
                                        <label className="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-widest">Question Payload</label>
                                        <textarea 
                                            required
                                            placeholder="أدخل نص السؤال هنا..."
                                            className="w-full cyber-input p-5 rounded-2xl text-lg font-bold"
                                            rows="2"
                                            value={formData.question_text}
                                            onChange={e => setFormData({...formData, question_text: e.target.value})}
                                        ></textarea>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <label className="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-widest">Options Module</label>
                                        <input required placeholder="الخيار أ" className="w-full cyber-input p-4 rounded-xl text-sm" value={formData.option_a} onChange={e => setFormData({...formData, option_a: e.target.value})} />
                                        <input required placeholder="الخيار ب" className="w-full cyber-input p-4 rounded-xl text-sm" value={formData.option_b} onChange={e => setFormData({...formData, option_b: e.target.value})} />
                                        <input required placeholder="الخيار ج" className="w-full cyber-input p-4 rounded-xl text-sm" value={formData.option_c} onChange={e => setFormData({...formData, option_c: e.target.value})} />
                                    </div>

                                    <div className="flex flex-col justify-between">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500 mb-4 block uppercase tracking-widest">Correct Index</label>
                                            <div className="grid grid-cols-3 gap-3">
                                                {[0, 1, 2].map(idx => (
                                                    <button 
                                                        key={idx}
                                                        type="button"
                                                        onClick={() => setFormData({...formData, correct_option: idx})}
                                                        className={`py-4 rounded-xl font-black orbitron border-2 transition-all ${formData.correct_option === idx ? 'bg-emerald-600 border-emerald-400 text-white shadow-[0_0_15px_rgba(16,185,129,0.3)]' : 'bg-white/5 border-transparent text-gray-500'}`}
                                                    >
                                                        {idx === 0 ? 'A' : idx === 1 ? 'B' : 'C'}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="mt-8">
                                            {status.msg && (
                                                <div className={`text-center p-3 rounded-xl mb-4 text-xs font-bold ${status.type === 'success' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}`}>
                                                    {status.msg}
                                                </div>
                                            )}
                                            <button 
                                                disabled={loading}
                                                className="w-full py-5 bg-gradient-to-r from-cyan-600 to-blue-700 hover:from-cyan-500 hover:to-blue-600 rounded-2xl font-black orbitron text-xl uppercase tracking-widest shadow-lg active:scale-95 transition-all disabled:opacity-50"
                                            >
                                                {loading ? 'SYNCING...' : 'Deploy Question'}
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            {/* List Section */}
                            <div className="glass p-8 rounded-[2.5rem]">
                                <h3 className="orbitron text-xs font-black text-gray-500 tracking-[0.5em] mb-8 uppercase">Active Sector Records</h3>
                                
                                {loading && questions.length === 0 ? (
                                    <div className="py-20 flex flex-col items-center opacity-40">
                                        <div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                        <p className="orbitron text-xs">Accessing Database...</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 gap-4">
                                        {filteredQuestions.map(q => (
                                            <div key={q.id} className="group bg-white/5 border border-white/5 p-6 rounded-[2rem] hover:bg-white/[0.08] transition-all flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <span className="orbitron text-[9px] bg-cyan-900/40 text-cyan-400 px-3 py-1 rounded-full font-black border border-cyan-500/20">UUID: {q.id.toString().slice(-6)}</span>
                                                        {q.assigned_to_ema && <span className="text-[9px] bg-purple-900/40 text-purple-300 px-3 py-1 rounded-full font-bold border border-purple-500/20">{q.assigned_to_ema}</span>}
                                                    </div>
                                                    <h4 className="text-xl font-bold text-white mb-4">{q.question_text}</h4>
                                                    <div className="flex flex-wrap gap-4">
                                                        {[q.option_a, q.option_b, q.option_c].map((opt, i) => (
                                                            <div key={i} className={`px-4 py-2 rounded-xl text-xs flex items-center gap-2 border ${q.correct_option === i ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400' : 'bg-black/20 border-white/5 text-gray-500'}`}>
                                                                <span className="orbitron font-black opacity-50">{i === 0 ? 'A' : i === 1 ? 'B' : 'C'}</span>
                                                                {opt}
                                                                {q.correct_option === i && <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path></svg>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => deleteQuestion(q.id)}
                                                    className="p-4 bg-red-500/10 text-red-500 rounded-2xl hover:bg-red-500 hover:text-white transition-all transform hover:rotate-6 active:scale-90"
                                                >
                                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </div>
                                        ))}

                                        {filteredQuestions.length === 0 && (
                                            <div className="text-center py-20 border-2 border-dashed border-white/5 rounded-[3rem]">
                                                <p className="text-gray-600 font-black orbitron text-xs uppercase tracking-[0.5em]">No Records Found In This Sector</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<AdminPortal />, document.getElementById('admin-root'));
    </script>
</body>
</html>